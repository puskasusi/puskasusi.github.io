<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>The Potatoe Connection</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="The Potatoe Connection">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="The Potatoe Connection">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="The Potatoe Connection">
  
    <link rel="alternate" href="/atom.xml" title="The Potatoe Connection" type="application/atom+xml">
  
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" integrity="sha384-XdYbMnZ/QjLh6iI4ogqCTaIjrFk87ip+ekIjefZch0Y+PvJ8CDYtEs1ipDmPorQ+" crossorigin="anonymous">

  <link rel="stylesheet" href="/css/styles.css">
  

</head>

<body>
  <nav class="navbar navbar-inverse">
  <div class="container">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#main-menu-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="main-menu-navbar">
      <ul class="nav navbar-nav">
        
          <li><a class="active"
                 href="/index.html">Home</a></li>
        
          <li><a class=""
                 href="/archives/">Archives</a></li>
        
      </ul>

      <!--
      <ul class="nav navbar-nav navbar-right">
        
          <li><a href="/atom.xml" title="RSS Feed"><i class="fa fa-rss"></i></a></li>
        
      </ul>
      -->
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>

  <div class="container">
    <div class="blog-header">
  <h1 class="blog-title">The Potatoe Connection</h1>
  
    <p class="lead blog-description">Stuff to share</p>
  
</div>

    <div class="row">
        <div class="col-sm-8 blog-main">
          
  
    <article id="post-Open-energy-monitor-on-Raspian-Stretch" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/27/Open-energy-monitor-on-Raspian-Stretch/">Open energy monitor on Raspian Stretch</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2017/09/27/Open-energy-monitor-on-Raspian-Stretch/" class="article-date"><time datetime="2017-09-27T08:55:48.000Z" itemprop="datePublished">2017-09-27</time></a>
</div>

    
    

  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Home-Energy-Monitor"><a href="#Home-Energy-Monitor" class="headerlink" title="Home Energy Monitor"></a>Home Energy Monitor</h1><p>I had recently received my open energy monitor package. I unwrapped an EmonTX module, a base station module and the EmonTH plus some accessories.</p>
<p>After connecting everything and setting up the Raspberry Pi the system was running without any problems. The only issue I had was that the Raspian was outdated. I decided to give it a try and setup the energy monitor on a stock Raspian Stretch image. This also allowed me to re-configure the emon software to the parts that I actually need and want.</p>
<p>The goal was to get to a clean setup with Raspian Stretch, node-red, influxdb and grafana.</p>
<img src="/2017/09/27/Open-energy-monitor-on-Raspian-Stretch/EmonPiArchitecture.png" alt="[EmonPiArchitecture.png]" title="[EmonPiArchitecture.png]">
<h1 id="Let’s-get-started"><a href="#Let’s-get-started" class="headerlink" title="Let’s get started"></a>Let’s get started</h1><h2 id="Raspian"><a href="#Raspian" class="headerlink" title="Raspian"></a>Raspian</h2><p>Download and install the Lite version of Raspian to a micro SD card. I used an 8 GB card, but the bigger the better.</p>
<p>Enable SSH.<br>Enable serial hardware, but do not enable the serial console.</p>
<h3 id="Install-influxdb"><a href="#Install-influxdb" class="headerlink" title="Install influxdb"></a>Install influxdb</h3><p>apt-get install influxdb-client influxdb-server</p>
<h3 id="Install-NodeJS"><a href="#Install-NodeJS" class="headerlink" title="Install NodeJS"></a>Install NodeJS</h3><p>curl -sL <a href="https://deb.nodesource.com/setup_6.x" target="_blank" rel="external">https://deb.nodesource.com/setup_6.x</a> | sudo -E bash -<br>sudo apt-get install -y nodejs</p>
<p>apt-get install build-essential python-rpi.gpio</p>
<h3 id="Node-red"><a href="#Node-red" class="headerlink" title="Node-red"></a>Node-red</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install node-red</div></pre></td></tr></table></figure>
<p>The npm install node-red does not come with service start and stop scripts. The corresponding scripts can be installed by fetching them from <a href="https://raw.githubusercontent.com/node-red/raspbian-deb-package/master/resources/" target="_blank" rel="external">https://raw.githubusercontent.com/node-red/raspbian-deb-package/master/resources/</a>. Run the follwing commands with sudo or as root.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">sudo wget https://raw.githubusercontent.com/node-red/raspbian-deb-package/master/resources/nodered.service -O /lib/systemd/system/nodered.service</div><div class="line">sudo wget https://raw.githubusercontent.com/node-red/raspbian-deb-package/master/resources/node-red-start -O /usr/bin/node-red-start</div><div class="line">sudo wget https://raw.githubusercontent.com/node-red/raspbian-deb-package/master/resources/node-red-stop -O /usr/bin/node-red-stop</div><div class="line">sudo chmod +x /usr/bin/node-red-st*</div><div class="line">sudo systemctl daemon-reload</div><div class="line">systemctl enable nodered.service</div></pre></td></tr></table></figure>
<p>Changing the systemd environment - using a proxy</p>
<p>If you need to use a proxy for http requests - you need to set the HTTP_PROXY environment variable. When using systemd this must be done within the service configuration. To edit this use sudo to edit the file /lib/systemd/system/nodered.service and add another Environment= line, for example:</p>
<p>Nice=5<br>Environment=”NODE_OPTIONS=–max-old-space-size=256”<br>Environment=”HTTP_PROXY=my-proxy-server-address”<br>Save the file, and then run:</p>
<p>sudo systemctl daemon-reload<br>to reload the configuration. Stop and restart Node-RED.</p>
<h3 id="grafana"><a href="#grafana" class="headerlink" title="grafana"></a>grafana</h3><p>wget <a href="https://bintray.com/fg2it/deb/download_file?file_path=main%2Fg%2Fgrafana_4.5.2_armhf.deb" target="_blank" rel="external">https://bintray.com/fg2it/deb/download_file?file_path=main%2Fg%2Fgrafana_4.5.2_armhf.deb</a></p>
<p>then<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">dpkg -i </div></pre></td></tr></table></figure><br>if the grafana service is not auto starting at the system boot , you can launch that command :<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sudo /bin/systemctl daemon-reload</div><div class="line">sudo systemctl enable grafana-server.service</div></pre></td></tr></table></figure></p>
<h3 id="emonhub"><a href="#emonhub" class="headerlink" title="emonhub"></a>emonhub</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">sudo apt-get install python-pip python-serial python-configobj git</div><div class="line">sudo pip install paho-mqtt</div><div class="line">sudo pip install pydispatcher</div></pre></td></tr></table></figure>
<p>Turn off persistence</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo vi /etc/mosquitto/mosquitto.conf</div></pre></td></tr></table></figure>
<p>set persistence to false</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git clone https://github.com/openenergymonitor/emonhub.git &amp;&amp; emonhub/install</div></pre></td></tr></table></figure>
<p>Change the emonhub settings to use ttyS0 instead of…</p>
<p>sudo service emonhub start</p>
<h1 id="Links"><a href="#Links" class="headerlink" title="Links"></a>Links</h1><a href="https://www.raspberrypi.org/downloads/raspbian/" title="https://www.raspberrypi.org/downloads/raspbian/" target="_blank" rel="external"></a>
<p><a href="https://www.raspberrypi.org/downloads/raspbian/" target="_blank" rel="external">https://www.raspberrypi.org/downloads/raspbian/</a><br><a href="https://github.com/openenergymonitor/emonhub.git" target="_blank" rel="external">https://github.com/openenergymonitor/emonhub.git</a></p>

      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/09/27/Open-energy-monitor-on-Raspian-Stretch/" data-id="cj86adh640000ex0i6qgeww8z" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
      

    </footer>
  </div>
  
</article>



  




        </div>
        <div class="col-sm-3 col-sm-offset-1 blog-sidebar">
          
  <div class="sidebar-module sidebar-module-inset">
  <h4>About</h4>
  <p>Stuff that I think is worth sharing or at least worth recording for myself.</p>

</div>


  


  


  

  
  <div class="sidebar-module">
    <h4>Archives</h4>
    <ul class="sidebar-module-list"><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/09/">September 2017</a><span class="sidebar-module-list-count">1</span></li></ul>
  </div>



  
  <div class="sidebar-module">
    <h4>Recents</h4>
    <ul class="sidebar-module-list">
      
        <li>
          <a href="/2017/09/27/Open-energy-monitor-on-Raspian-Stretch/">Open energy monitor on Raspian Stretch</a>
        </li>
      
    </ul>
  </div>



        </div>
    </div>
  </div>
  <footer class="blog-footer">
  <div class="container">
    <div id="footer-info" class="inner">
      &copy; 2017 Antti Puskasusi<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

  

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js" integrity="sha384-8gBf6Y4YYq7Jx97PIqmTwLPin4hxIzQw5aDmUg/DDhul9fFpbbLcLh3nTIIDJKhx" crossorigin="anonymous"></script>

<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>



<script src="/js/script.js"></script>

</body>
</html>
